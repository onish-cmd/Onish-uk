name: Build Onish-Kernel Image

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@nightly
      with:
        components: rust-src

    - name: Install ARM & Boot Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-arm-none-eabi u-boot-tools dosfstools mtools wget

    - name: Build Kernel (ELF)
      run: |
        cargo build --release --target target.json -Z build-std=core,compiler_builtins

    - name: Create U-Boot Kernel Image
      run: |
        # Using -a 0 and -e 0 because your code is PIC and the linker is at 0x0
        mkimage -A arm -O u-boot -T kernel -C none \
          -a 0 -e 0 \
          -n "Onish-Kernel" -d target/target/release/kernel onish-kernel.img

    - name: Compile Boot Script
      run: |
        mkimage -A arm -T script -C none -n "Onish Boot" -d boot.source boot.scr

    - name: Download QEMU U-Boot
      run: |
        wget https://ftp.denx.de/pub/u-boot/u-boot.bin -O u-boot.bin || \
        wget https://github.com/u-boot/u-boot/raw/master/u-boot.bin -O u-boot.bin

    - name: Package SD Card Image
      run: |
        dd if=/dev/zero of=onish-os.img bs=1M count=64
        mkfs.vfat -F 32 onish-os.img
        # Add the kernel and the compiled boot script
        mcopy -i onish-os.img onish-kernel.img ::onish-kernel.img
        mcopy -i onish-os.img boot.scr ::boot.scr

    - name: Upload Everything
      uses: actions/upload-artifact@v4
      with:
        name: onish-kernel-full-package
        path: |
          onish-os.img
          u-boot.bin
